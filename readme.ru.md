# GitLab Мониторинг Коммитов

Система для мониторинга коммитов в репозиториях GitLab с автоматическим анализом изменений с помощью LLM и уведомлением в Telegram.

## Функциональные возможности

- Мониторинг нескольких репозиториев GitLab
- Анализ изменений кода с помощью LLM для выявления потенциальных ошибок
- Детектирование проблем в коде, включая логические ошибки и уязвимости
- Отправка уведомлений в Telegram с детальным описанием изменений
- Гибкая настройка параметров мониторинга через аргументы командной строки
- Поддержка различных форматов дат и часовых поясов

## Требования

- Python 3.8+
- Токен доступа к GitLab API
- API ключ OpenRouter (для LLM анализа кода)
- Telegram бот и ID чата для отправки уведомлений

## Установка

1. Клонируйте репозиторий:
```
git clone <url-репозитория>
cd <директория-репозитория>
```

2. Установите зависимости:
```
pip install -r requirements.txt
```

3. Создайте файл `.env` на основе примера ниже:
```
# Настройки GitLab
GITLAB_URL=https://gitlab.com
GITLAB_TOKEN=glpat-xxxxxxxxxxxxxxxxxxx

# Настройки Telegram
TELEGRAM_TOKEN=5555555555:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
CHAT_ID=123456789

# Интервал проверки (в секундах)
CHECK_INTERVAL=300

# Путь к базе данных SQLite
DB_PATH=commits.db

# Настройки OpenRouter API для LLM анализа
OPENROUTER_API_KEY=sk-or-xxxxxxxxxxxxxxxxxxxxxxxxxxxx
YOUR_SITE_URL=https://example.com
YOUR_SITE_NAME=GitLab Monitor

# Список репозиториев для мониторинга (разделенный запятыми)
REPOSITORIES=nordic/finance/payment-gateway,nordic/finance/transaction-service
```

## Настройка интеграций

### Настройка токена GitLab

1. В GitLab перейдите в свой профиль: `Preferences` → `Access Tokens`
2. Создайте новый токен с правами:
   - `read_api` (для чтения данных репозиториев)
   - `read_repository` (для доступа к содержимому репозиториев)
3. Скопируйте полученный токен в переменную `GITLAB_TOKEN` в файле `.env`

### Настройка Telegram бота

1. Создайте нового бота через [@BotFather](https://t.me/BotFather)
2. Получите токен бота и скопируйте его в переменную `TELEGRAM_TOKEN`
3. Для получения Chat ID:
   - Добавьте бота в нужный чат
   - Отправьте сообщение в этот чат
   - Получите ID чата через API: `https://api.telegram.org/bot<token>/getUpdates`
   - Скопируйте значение `chat.id` в переменную `CHAT_ID`

### Настройка OpenRouter API

1. Зарегистрируйтесь на [OpenRouter](https://openrouter.ai/)
2. Создайте API ключ в разделе Settings
3. Скопируйте ключ в переменную `OPENROUTER_API_KEY`
4. Заполните поля `YOUR_SITE_URL` и `YOUR_SITE_NAME` для корректной идентификации

## Использование

### Базовый запуск

Для мониторинга всех репозиториев из списка с настройками по умолчанию:

```
python main.py
```

### Расширенные варианты запуска

#### Мониторинг конкретного репозитория

```
python main.py --repo nordic/finance/payment-gateway
```

#### Проверка изменений с указанного времени

```
python main.py --since "2025-03-19 17:22"
```

#### Проверка за последние N часов

```
python main.py --hours 4
```

#### Режим отладки с расширенным логированием

```
python main.py --debug
```

#### Ограничение объема анализируемых данных

```
python main.py --max-files 3 --max-file-size 50000
```

#### Комбинация параметров

```
python main.py --repo nordic/finance/transaction-service --hours 2 --debug
```

```
python main.py --repo nordic/finance/payment-gateway --max-file-size 128000
```

## Структура проекта

- `main.py` - основной скрипт мониторинга
- `commits.db` - SQLite база данных для отслеживания обработанных коммитов
- `.env` - файл с конфигурационными параметрами

## Описание классов

- `DBManager` - управление SQLite базой данных для отслеживания коммитов
- `GitLabClient` - взаимодействие с GitLab API для получения информации о коммитах
- `LLMAnalyzer` - анализ изменений кода с использованием OpenRouter API
- `TelegramNotifier` - отправка уведомлений через Telegram API
- `CommitMonitor` - основной класс, координирующий работу всех компонентов

## Устранение неполадок

### Проблемы с доступом к GitLab API

Убедитесь, что:
- Токен GitLab не просрочен
- Токен имеет необходимые права доступа
- URL GitLab указан корректно (включая протокол https://)
- Вы имеете доступ к указанным репозиториям

### Проблемы с Telegram

- Убедитесь, что бот добавлен в нужный чат
- Проверьте правильность токена бота и Chat ID
- Для групповых чатов ID должен начинаться с минуса (например, -1001234567890)

### Проблемы с OpenRouter API

- Проверьте баланс и лимиты вашего аккаунта на OpenRouter
- Убедитесь, что модель `openai/gpt-4o-mini` доступна в вашем тарифе
- При ошибках с превышением лимита токенов уменьшите параметры `max-file-size` и `max-files`

### Проблемы с парсингом даты

Система поддерживает различные форматы даты GitLab. При проблемах убедитесь, что:
- Часовой пояс в параметре `--since` соответствует вашему локальному времени
- По умолчанию используется часовой пояс 'Europe/Stockholm'

### Расширенная отладка

Для детального анализа работы системы используйте:

```
python main.py --debug --repo nordic/finance/payment-gateway
```

## Пример уведомления в Telegram

```
nordic/finance/payment-gateway: [a1b2c3d](https://gitlab.com/nordic/finance/payment-gateway/-/commit/a1b2c3d)
Оптимизация функции обработки платежей
Автор: Klaus Schmidt
Изменения: Добавлена валидация входных данных и улучшена обработка ошибок в API endpoints

⚠️ Ошибки: Возможная проблема с обработкой null-значений в файле payment_controller.py, строка 127
```

## Планы развития

- Интеграция с GitHub (в разработке)
- Поддержка анализа различных языков программирования
- Расширенная настройка фильтрации репозиториев
- Интерактивные команды в Telegram для управления мониторингом

## Лицензия

MIT
