# Моніторинг комітів GitLab

Система для моніторингу комітів у репозиторіях GitLab з автоматичним аналізом змін за допомогою LLM та сповіщеннями у Telegram.

## Функціональні можливості

- Моніторинг декількох репозиторіїв GitLab
- Аналіз змін коду за допомогою LLM для виявлення потенційних помилок
- Виявлення проблем у коді, включаючи логічні помилки та вразливості
- Надсилання сповіщень у Telegram з детальним описом змін
- Гнучке налаштування параметрів моніторингу через аргументи командного рядка
- Підтримка різних форматів дат та часових поясів

## Вимоги

- Python 3.8+
- Токен доступу до GitLab API
- API ключ OpenRouter (для LLM аналізу коду)
- Telegram бот та ID чату для надсилання сповіщень

## Встановлення

1. Клонуйте репозиторій:
```
git clone <url-репозиторію>
cd <директорія-репозиторію>
```

2. Встановіть залежності:
```
pip install -r requirements.txt
```

3. Створіть файл `.env` на основі прикладу нижче:
```
# Налаштування GitLab
GITLAB_URL=https://gitlab.com
GITLAB_TOKEN=glpat-xxxxxxxxxxxxxxxxxxx

# Налаштування Telegram
TELEGRAM_TOKEN=5555555555:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
CHAT_ID=123456789

# Інтервал перевірки (в секундах)
CHECK_INTERVAL=300

# Шлях до бази даних SQLite
DB_PATH=commits.db

# Налаштування OpenRouter API для LLM аналізу
OPENROUTER_API_KEY=sk-or-xxxxxxxxxxxxxxxxxxxxxxxxxxxx
YOUR_SITE_URL=https://example.com
YOUR_SITE_NAME=GitLab Monitor

# Список репозиторіїв для моніторингу (розділений комами)
REPOSITORIES=nordic/finance/payment-gateway,nordic/finance/transaction-service
```

## Налаштування інтеграцій

### Налаштування токену GitLab

1. У GitLab перейдіть до свого профілю: `Preferences` → `Access Tokens`
2. Створіть новий токен з правами:
   - `read_api` (для читання даних репозиторіїв)
   - `read_repository` (для доступу до вмісту репозиторіїв)
3. Скопіюйте отриманий токен у змінну `GITLAB_TOKEN` у файлі `.env`

### Налаштування Telegram бота

1. Створіть нового бота через [@BotFather](https://t.me/BotFather)
2. Отримайте токен бота та скопіюйте його у змінну `TELEGRAM_TOKEN`
3. Для отримання Chat ID:
   - Додайте бота до потрібного чату
   - Надішліть повідомлення в цей чат
   - Отримайте ID чату через API: `https://api.telegram.org/bot<token>/getUpdates`
   - Скопіюйте значення `chat.id` у змінну `CHAT_ID`

### Налаштування OpenRouter API

1. Зареєструйтесь на [OpenRouter](https://openrouter.ai/)
2. Створіть API ключ у розділі Settings
3. Скопіюйте ключ у змінну `OPENROUTER_API_KEY`
4. Заповніть поля `YOUR_SITE_URL` та `YOUR_SITE_NAME` для коректної ідентифікації

## Використання

### Базовий запуск

Для моніторингу всіх репозиторіїв зі списку з налаштуваннями за замовчуванням:

```
python main.py
```

### Розширені варіанти запуску

#### Моніторинг конкретного репозиторію

```
python main.py --repo nordic/finance/payment-gateway
```

#### Перевірка змін із вказаного часу

```
python main.py --since "2025-03-19 17:22"
```

#### Перевірка за останні N годин

```
python main.py --hours 4
```

#### Режим налагодження з розширеним логуванням

```
python main.py --debug
```

#### Обмеження обсягу даних для аналізу

```
python main.py --max-files 3 --max-file-size 50000
```

#### Комбінація параметрів

```
python main.py --repo nordic/finance/transaction-service --hours 2 --debug
```

```
python main.py --repo nordic/finance/payment-gateway --max-file-size 128000
```

## Структура проекту

- `main.py` - основний скрипт моніторингу
- `commits.db` - база даних SQLite для відстеження оброблених комітів
- `.env` - файл із конфігураційними параметрами

## Опис класів

- `DBManager` - управління базою даних SQLite для відстеження комітів
- `GitLabClient` - взаємодія з GitLab API для отримання інформації про коміти
- `LLMAnalyzer` - аналіз змін коду з використанням OpenRouter API
- `TelegramNotifier` - надсилання сповіщень через Telegram API
- `CommitMonitor` - основний клас, що координує роботу всіх компонентів

## Усунення несправностей

### Проблеми з доступом до GitLab API

Переконайтеся, що:
- Токен GitLab не закінчився
- Токен має необхідні права доступу
- URL GitLab вказано коректно (включаючи протокол https://)
- Ви маєте доступ до вказаних репозиторіїв

### Проблеми з Telegram

- Переконайтеся, що бот додано до потрібного чату
- Перевірте правильність токену бота та Chat ID
- Для групових чатів ID має починатися з мінуса (наприклад, -1001234567890)

### Проблеми з OpenRouter API

- Перевірте баланс та ліміти вашого акаунту на OpenRouter
- Переконайтеся, що модель `openai/gpt-4o-mini` доступна у вашому тарифі
- При помилках з перевищенням ліміту токенів зменшіть параметри `max-file-size` та `max-files`

### Проблеми з парсингом дати

Система підтримує різні формати дати GitLab. При проблемах переконайтеся, що:
- Часовий пояс у параметрі `--since` відповідає вашому локальному часу
- За замовчуванням використовується часовий пояс 'Europe/Stockholm'

### Розширене налагодження

Для детального аналізу роботи системи використовуйте:

```
python main.py --debug --repo nordic/finance/payment-gateway
```

## Приклад сповіщення у Telegram

```
nordic/finance/payment-gateway: [a1b2c3d](https://gitlab.com/nordic/finance/payment-gateway/-/commit/a1b2c3d)
Оптимізація функції обробки платежів
Автор: Klaus Schmidt
Зміни: Додано валідацію вхідних даних та покращено обробку помилок в API endpoints

⚠️ Помилки: Можлива проблема з обробкою null-значень у файлі payment_controller.py, рядок 127
```

## Плани розвитку

- Інтеграція з GitHub (в розробці)
- Підтримка аналізу різних мов програмування
- Розширені налаштування фільтрації репозиторіїв
- Інтерактивні команди в Telegram для управління моніторингом

## Ліцензія

MIT
